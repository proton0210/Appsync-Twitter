"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataBaseStack = void 0;
const NotificationsTable_1 = require("./Constructs/NotificationsTable");
const RelationshipsTable_1 = require("./Constructs/RelationshipsTable");
const RetweetsTable_1 = require("./Constructs/RetweetsTable");
const LikesTable_1 = require("./Constructs/LikesTable");
const TweetsTable_1 = require("./Constructs/TweetsTable");
const cdk = require("aws-cdk-lib");
const eventsources = require("aws-cdk-lib/aws-lambda-event-sources");
const UsersTable_1 = require("./Constructs/UsersTable");
const TimelinesTable_1 = require("./Constructs/TimelinesTable");
class DataBaseStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.props = props;
        this.initialize();
    }
    initialize() {
        this.initializeUserTableWithAccess();
        this.initializeTweetsTableWithAccess();
        this.initializeTimeLinesTableWithAccess();
        this.initializeLikesTableWithAccess();
        this.initializeRetweetTableWithAccess();
        this.initializeRelationshipsTableWithAccess();
        this.initializeNotificationTableWithAccess();
    }
    initializeUserTableWithAccess() {
        this.usersTable = new UsersTable_1.UsersTable(this, 'UsersTable');
        this.usersTable.table.grantFullAccess(this.props.postConfirmationHook);
        this.props.syncUserstoAlgolia.addEventSource(new eventsources.DynamoEventSource(this.usersTable.table, {
            startingPosition: cdk.aws_lambda.StartingPosition.LATEST
        }));
    }
    initializeTweetsTableWithAccess() {
        this.tweetsTable = new TweetsTable_1.TweetsTable(this, 'TweetsTable');
        this.tweetsTable.table.grantFullAccess(this.props.distributeTweetWithFollowers);
        this.props.distributedTweet.addEventSource(new eventsources.DynamoEventSource(this.tweetsTable.table, {
            startingPosition: cdk.aws_lambda.StartingPosition.LATEST
        }));
        this.props.syncTweetsToAlgolia.addEventSource(new eventsources.DynamoEventSource(this.tweetsTable.table, {
            startingPosition: cdk.aws_lambda.StartingPosition.LATEST
        }));
        this.props.Notify.addEventSource(new eventsources.DynamoEventSource(this.tweetsTable.table, {
            startingPosition: cdk.aws_lambda.StartingPosition.LATEST
        }));
    }
    initializeTimeLinesTableWithAccess() {
        this.timelinesTable = new TimelinesTable_1.TimelinesTable(this, 'TimelinesTable');
        this.timelinesTable.table.grantFullAccess(this.props.distributedTweet);
        this.timelinesTable.table.grantFullAccess(this.props.distributeTweetWithFollowers);
    }
    initializeLikesTableWithAccess() {
        this.likesTable = new LikesTable_1.LikesTable(this, 'LikesTable');
    }
    initializeRetweetTableWithAccess() {
        this.retweetTable = new RetweetsTable_1.RetweetsTable(this, 'RetweetsTable');
    }
    initializeRelationshipsTableWithAccess() {
        this.relationShipsTable = new RelationshipsTable_1.RelationshipsTable(this, 'RelationshipsTable');
        this.relationShipsTable.table.grantFullAccess(this.props.distributedTweet);
        this.relationShipsTable.table.grantFullAccess(this.props.distributeTweetWithFollowers);
        this.props.distributeTweetWithFollowers.addEventSource(new eventsources.DynamoEventSource(this.relationShipsTable.table, {
            startingPosition: cdk.aws_lambda.StartingPosition.LATEST
        }));
    }
    initializeNotificationTableWithAccess() {
        this.notificationsTable = new NotificationsTable_1.NotificationTable(this, 'NotificationTable');
    }
}
exports.DataBaseStack = DataBaseStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2Utc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkYXRhYmFzZS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx3RUFBb0U7QUFDcEUsd0VBQXFFO0FBQ3JFLDhEQUEyRDtBQUMzRCx3REFBcUQ7QUFDckQsMERBQXVEO0FBRXZELG1DQUFtQztBQUNuQyxxRUFBcUU7QUFFckUsd0RBQXFEO0FBQ3JELGdFQUE2RDtBQUU3RCxNQUFhLGFBQWMsU0FBUSxHQUFHLENBQUMsS0FBSztJQVUxQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXlCO1FBQ2pFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUNwQixDQUFDO0lBRUQsVUFBVTtRQUNSLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQywrQkFBK0IsRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxrQ0FBa0MsRUFBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO1FBQ3hDLElBQUksQ0FBQyxzQ0FBc0MsRUFBRSxDQUFDO1FBQzlDLElBQUksQ0FBQyxxQ0FBcUMsRUFBRSxDQUFDO0lBQy9DLENBQUM7SUFFRCw2QkFBNkI7UUFDM0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLHVCQUFVLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQzFDLElBQUks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QUFJLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztJQUM3RSxDQUFDO0NBQ0Y7QUE5RkQsc0NBOEZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTm90aWZpY2F0aW9uVGFibGUgfSBmcm9tICcuL0NvbnN0cnVjdHMvTm90aWZpY2F0aW9uc1RhYmxlJztcbmltcG9ydCB7IFJlbGF0aW9uc2hpcHNUYWJsZSB9IGZyb20gJy4vQ29uc3RydWN0cy9SZWxhdGlvbnNoaXBzVGFibGUnO1xuaW1wb3J0IHsgUmV0d2VldHNUYWJsZSB9IGZyb20gJy4vQ29uc3RydWN0cy9SZXR3ZWV0c1RhYmxlJztcbmltcG9ydCB7IExpa2VzVGFibGUgfSBmcm9tICcuL0NvbnN0cnVjdHMvTGlrZXNUYWJsZSc7XG5pbXBvcnQgeyBUd2VldHNUYWJsZSB9IGZyb20gJy4vQ29uc3RydWN0cy9Ud2VldHNUYWJsZSc7XG5pbXBvcnQgeyBEYXRhQmFzZVN0YWNrUHJvcHMgfSBmcm9tICcuLy4uLy4uLy4uL0ludGVyZmFjZXMvZGF0YWJhc2UtaW50ZXJmYWNlJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBldmVudHNvdXJjZXMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ldmVudC1zb3VyY2VzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgVXNlcnNUYWJsZSB9IGZyb20gJy4vQ29uc3RydWN0cy9Vc2Vyc1RhYmxlJztcbmltcG9ydCB7IFRpbWVsaW5lc1RhYmxlIH0gZnJvbSAnLi9Db25zdHJ1Y3RzL1RpbWVsaW5lc1RhYmxlJztcblxuZXhwb3J0IGNsYXNzIERhdGFCYXNlU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBwdWJsaWMgdXNlcnNUYWJsZTogVXNlcnNUYWJsZTtcbiAgcHVibGljIHR3ZWV0c1RhYmxlOiBUd2VldHNUYWJsZTtcbiAgcHVibGljIHRpbWVsaW5lc1RhYmxlOiBUaW1lbGluZXNUYWJsZTtcbiAgcHVibGljIGxpa2VzVGFibGU6IExpa2VzVGFibGU7XG4gIHB1YmxpYyByZXR3ZWV0VGFibGU6IFJldHdlZXRzVGFibGU7XG4gIHB1YmxpYyByZWxhdGlvblNoaXBzVGFibGU6IFJlbGF0aW9uc2hpcHNUYWJsZTtcbiAgcHVibGljIG5vdGlmaWNhdGlvbnNUYWJsZTogTm90aWZpY2F0aW9uVGFibGU7XG4gIHB1YmxpYyBwcm9wczogRGF0YUJhc2VTdGFja1Byb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBEYXRhQmFzZVN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG4gICAgdGhpcy5pbml0aWFsaXplKCk7XG4gIH1cblxuICBpbml0aWFsaXplKCkge1xuICAgIHRoaXMuaW5pdGlhbGl6ZVVzZXJUYWJsZVdpdGhBY2Nlc3MoKTtcbiAgICB0aGlzLmluaXRpYWxpemVUd2VldHNUYWJsZVdpdGhBY2Nlc3MoKTtcbiAgICB0aGlzLmluaXRpYWxpemVUaW1lTGluZXNUYWJsZVdpdGhBY2Nlc3MoKTtcbiAgICB0aGlzLmluaXRpYWxpemVMaWtlc1RhYmxlV2l0aEFjY2VzcygpO1xuICAgIHRoaXMuaW5pdGlhbGl6ZVJldHdlZXRUYWJsZVdpdGhBY2Nlc3MoKTtcbiAgICB0aGlzLmluaXRpYWxpemVSZWxhdGlvbnNoaXBzVGFibGVXaXRoQWNjZXNzKCk7XG4gICAgdGhpcy5pbml0aWFsaXplTm90aWZpY2F0aW9uVGFibGVXaXRoQWNjZXNzKCk7XG4gIH1cblxuICBpbml0aWFsaXplVXNlclRhYmxlV2l0aEFjY2VzcygpIHtcbiAgICB0aGlzLnVzZXJzVGFibGUgPSBuZXcgVXNlcnNUYWJsZSh0aGlzLCAnVXNlcnNUYWJsZScpO1xuICAgIHRoaXMudXNlcnNUYWJsZS50YWJsZS5ncmFudEZ1bGxBY2Nlc3ModGhpcy5wcm9wcy5wb3N0Q29uZmlybWF0aW9uSG9vayk7XG4gICAgdGhpcy5wcm9wcy5zeW5jVXNlcnN0b0FsZ29saWEuYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgZXZlbnRzb3VyY2VzLkR5bmFtb0V2ZW50U291cmNlKHRoaXMudXNlcnNUYWJsZS50YWJsZSwge1xuICAgICAgICBzdGFydGluZ1Bvc2l0aW9uOiBjZGsuYXdzX2xhbWJkYS5TdGFydGluZ1Bvc2l0aW9uLkxBVEVTVFxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgaW5pdGlhbGl6ZVR3ZWV0c1RhYmxlV2l0aEFjY2VzcygpIHtcbiAgICB0aGlzLnR3ZWV0c1RhYmxlID0gbmV3IFR3ZWV0c1RhYmxlKHRoaXMsICdUd2VldHNUYWJsZScpO1xuICAgIHRoaXMudHdlZXRzVGFibGUudGFibGUuZ3JhbnRGdWxsQWNjZXNzKFxuICAgICAgdGhpcy5wcm9wcy5kaXN0cmlidXRlVHdlZXRXaXRoRm9sbG93ZXJzXG4gICAgKTtcbiAgICB0aGlzLnByb3BzLmRpc3RyaWJ1dGVkVHdlZXQuYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgZXZlbnRzb3VyY2VzLkR5bmFtb0V2ZW50U291cmNlKHRoaXMudHdlZXRzVGFibGUudGFibGUsIHtcbiAgICAgICAgc3RhcnRpbmdQb3NpdGlvbjogY2RrLmF3c19sYW1iZGEuU3RhcnRpbmdQb3NpdGlvbi5MQVRFU1RcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMucHJvcHMuc3luY1R3ZWV0c1RvQWxnb2xpYS5hZGRFdmVudFNvdXJjZShcbiAgICAgIG5ldyBldmVudHNvdXJjZXMuRHluYW1vRXZlbnRTb3VyY2UodGhpcy50d2VldHNUYWJsZS50YWJsZSwge1xuICAgICAgICBzdGFydGluZ1Bvc2l0aW9uOiBjZGsuYXdzX2xhbWJkYS5TdGFydGluZ1Bvc2l0aW9uLkxBVEVTVFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgdGhpcy5wcm9wcy5Ob3RpZnkuYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgZXZlbnRzb3VyY2VzLkR5bmFtb0V2ZW50U291cmNlKHRoaXMudHdlZXRzVGFibGUudGFibGUsIHtcbiAgICAgICAgc3RhcnRpbmdQb3NpdGlvbjogY2RrLmF3c19sYW1iZGEuU3RhcnRpbmdQb3NpdGlvbi5MQVRFU1RcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGluaXRpYWxpemVUaW1lTGluZXNUYWJsZVdpdGhBY2Nlc3MoKSB7XG4gICAgdGhpcy50aW1lbGluZXNUYWJsZSA9IG5ldyBUaW1lbGluZXNUYWJsZSh0aGlzLCAnVGltZWxpbmVzVGFibGUnKTtcbiAgICB0aGlzLnRpbWVsaW5lc1RhYmxlLnRhYmxlLmdyYW50RnVsbEFjY2Vzcyh0aGlzLnByb3BzLmRpc3RyaWJ1dGVkVHdlZXQpO1xuICAgIHRoaXMudGltZWxpbmVzVGFibGUudGFibGUuZ3JhbnRGdWxsQWNjZXNzKFxuICAgICAgdGhpcy5wcm9wcy5kaXN0cmlidXRlVHdlZXRXaXRoRm9sbG93ZXJzXG4gICAgKTtcbiAgfVxuXG4gIGluaXRpYWxpemVMaWtlc1RhYmxlV2l0aEFjY2VzcygpIHtcbiAgICB0aGlzLmxpa2VzVGFibGUgPSBuZXcgTGlrZXNUYWJsZSh0aGlzLCAnTGlrZXNUYWJsZScpO1xuICB9XG4gIGluaXRpYWxpemVSZXR3ZWV0VGFibGVXaXRoQWNjZXNzKCkge1xuICAgIHRoaXMucmV0d2VldFRhYmxlID0gbmV3IFJldHdlZXRzVGFibGUodGhpcywgJ1JldHdlZXRzVGFibGUnKTtcbiAgfVxuXG4gIGluaXRpYWxpemVSZWxhdGlvbnNoaXBzVGFibGVXaXRoQWNjZXNzKCkge1xuICAgIHRoaXMucmVsYXRpb25TaGlwc1RhYmxlID0gbmV3IFJlbGF0aW9uc2hpcHNUYWJsZShcbiAgICAgIHRoaXMsXG4gICAgICAnUmVsYXRpb25zaGlwc1RhYmxlJ1xuICAgICk7XG4gICAgdGhpcy5yZWxhdGlvblNoaXBzVGFibGUudGFibGUuZ3JhbnRGdWxsQWNjZXNzKHRoaXMucHJvcHMuZGlzdHJpYnV0ZWRUd2VldCk7XG4gICAgdGhpcy5yZWxhdGlvblNoaXBzVGFibGUudGFibGUuZ3JhbnRGdWxsQWNjZXNzKFxuICAgICAgdGhpcy5wcm9wcy5kaXN0cmlidXRlVHdlZXRXaXRoRm9sbG93ZXJzXG4gICAgKTtcbiAgICB0aGlzLnByb3BzLmRpc3RyaWJ1dGVUd2VldFdpdGhGb2xsb3dlcnMuYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgZXZlbnRzb3VyY2VzLkR5bmFtb0V2ZW50U291cmNlKHRoaXMucmVsYXRpb25TaGlwc1RhYmxlLnRhYmxlLCB7XG4gICAgICAgIHN0YXJ0aW5nUG9zaXRpb246IGNkay5hd3NfbGFtYmRhLlN0YXJ0aW5nUG9zaXRpb24uTEFURVNUXG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBpbml0aWFsaXplTm90aWZpY2F0aW9uVGFibGVXaXRoQWNjZXNzKCkge1xuICAgIHRoaXMubm90aWZpY2F0aW9uc1RhYmxlID0gbmV3IE5vdGlmaWNhdGlvblRhYmxlKHRoaXMsICdOb3RpZmljYXRpb25UYWJsZScpO1xuICB9XG59XG4iXX0=